
# Challenge \#2 - Custom Queries & Watchlists

[< Previous Challenge](./Challenge-01.md) - **[Home](../readme.md)** - [Next Challenge>](./Challenge-03.md)

## Pre-requisites 

**- Challenge-01 needs to be complete; this challenge is dependent on having logon events 4624 and 4625 sent to the Sentinel Log Analytics workspace** </br></br>
**- 90 to 120 minutes**

## Introduction 

A big part of running a SEIM/SOAR solution is triaging as many of the 'false' positives as possible.  False is in quotes because we still want to keep the data, it is potentially useful, but we know that many alerts/incidents can be closed automatically as they are expected behaviors. </br>
In this challenge, we will create and Alert/Incident based on tracking logins to our server.  The objective is to ensure that we know everytime a user logs into the machine, or fails to log into the machine.  Select two tactics that represent what kind of attack could be underway using the Mitre.org framework.
</br>


## Description
</br>

**Part 1 - Alerts**  </br>
**-------------------** </br>
***Step 1:*** Create an Alert and an Incident based on a user logon . Include the account of the user that logged on and the IP address as Entities. </br>

***Step 2:*** Write down your justification for tactics selected, severity, query scheduling, alert threshold and event grouping. </br>

***Step 3:*** Reporting - Create a workbook that tracks the number alerts generated by user activity - successful and failed logon attempts.

</br>

**Part 1 Success Criteria**

- An alert and incident are created whenever you login to one of the VM's being monitored.
- You can explain your choices around query scheduling, thresholds and groupings
- Workbook that shows the alerts/incidents for your newly created alert.

</br>

**Part 2 - Watchlists**  </br>
**---------------------** </br>
***Step 1:*** Create a Watchlist containing a userName and an IPAddress. Include your home IP address.  (Hint:  Alias â€“ validips) </br>
E.g. </br>
          
   ![image](https://user-images.githubusercontent.com/22599225/146422480-ba366474-b9d9-47e3-8b12-4527391ab15c.png)

***Step 2:*** Modify the Watchlist and add another row containing "AsiaAdmin" and the home/work IP address of one of your WTH colleagues. </br>

E.g.    AsiaAdmin, 173.135.10.193

***Step 3:*** Set the retention date for Watchlist table to 7 days maximum. (Hint: ARM template) and validate the date has been set correctly </br>
 </br>


**Part 2 Success Criteria**

- The Watchlist exists  </br>
- The user has been added </br>
- The teams (individuals) are able to show the retention data has been set to 7 days on that watchlist </br>

## Learning Resources

Mitre Attack framework: https://attack.mitre.org/

Azure Sentinel Watchlists: https://docs.microsoft.com/en-us/azure/sentinel/watchlists

Creating a custom analytics rule to detect threats: https://docs.microsoft.com/en-us/azure/sentinel/detect-threats-custom

Creatinng Sentinel Workbooks: https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/azure-sentinel-workbooks-101-with-sample-workbook/ba-p/1409216

Sentinel Ninja training https://techcommunity.microsoft.com/t5/azure-sentinel/the-ninja-training-2021-edition-is-out/ba-p/2027400 

</br>

## Tips

Look for resources that can help you with setting table retention and verifying it</br>

Each alert is one incident</br>
</br>

## Advanced Challenges 

**Too comfortable?  Eager to do more?  Try these additional challenges!**

A) Alert on RDP Session connection only </br>
B) Create a workbook that tracks the top five alerts by severity, the top five by volume, and the top five over the past 24 hours. </br>
C) Create a playbook to add the 'unknown' IP address to the NSG of the relevent subnet of the resource being targeted </br>
